<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>PH CRM Balance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
      :root {
        --primary-color: #1e90ff;
        --bg-color: #121212;
        --text-color: #ffffff;
        --card-bg: #1e1e1e;
        --border-radius: 12px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Roboto, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .container {
        padding: 16px;
        flex: 1;
        overflow-y: auto;
      }

      h2 {
        text-align: center;
        margin-top: 0;
        color: var(--primary-color);
      }

      .auth-section,
      .main-section {
        display: none;
      }

      .input-group {
        margin-bottom: 16px;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: var(--border-radius);
        background-color: var(--card-bg);
        color: var(--text-color);
        font-size: 16px;
      }

      button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: var(--border-radius);
        background-color: var(--primary-color);
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      button:disabled {
        background-color: #888;
        cursor: not-allowed;
      }

      .result-card {
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 16px;
        margin-top: 20px;
      }

      .result-card p {
        margin: 8px 0;
      }

      .qr-button {
        background-color: #2ecc71;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 50px;
      }

      .scanner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-color);
        z-index: 1000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
      }

      .scanner-container.active {
        display: flex;
      }

      .close-scanner {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        padding: 8px;
        color: white;
        font-size: 24px;
        border: none;
        cursor: pointer;
        z-index: 1001;
      }

      #reader {
        width: 90%;
        max-width: 400px;
        min-height: 200px;
        margin: 20px auto;
        background-color: #333;
        border: 1px solid #555;
        overflow: hidden;
      }

      #reader video {
        width: 100% !important;
        height: auto !important;
        border-radius: var(--border-radius);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="auth-section" id="authSection">
        <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <div class="input-group">
          <input type="text" id="authToken" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω" />
        </div>
        <button onclick="registerOrganization()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>

      <div class="main-section" id="mainSection">
        <h2>üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</h2>

        <!-- –ï–¥–∏–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div class="input-group">
          <input
            type="text"
            id="searchInput"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
          />
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR -->
        <button class="qr-button" onclick="toggleQR()">
          üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR
        </button>

        <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
        <button onclick="searchClient()">üîç –ü–æ–∏—Å–∫</button>

        <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
        <div class="result-card" id="resultCard"></div>
      </div>
    </div>

    <div class="scanner-container" id="scannerContainer">
      <button class="close-scanner" onclick="closeScanner()">‚úï</button>
      <div id="reader"></div>
    </div>

    <script>
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
      Telegram.WebApp.ready();

      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ URL
      const urlParams = new URLSearchParams(window.location.search);
      let authToken = urlParams.get("token");
      let isRegistered = false;

      const authSection = document.getElementById("authSection");
      const mainSection = document.getElementById("mainSection");
      const resultCard = document.getElementById("resultCard");

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞
      if (!authToken) {
        authSection.style.display = "block";
      } else {
        mainSection.style.display = "block";
        checkOrganizationRegistration();
      }

      let html5QrcodeScanner = null;

      async function registerOrganization() {
        const tokenInput = document.getElementById("authToken");
        authToken = tokenInput.value.trim();

        if (!authToken) {
          alert("–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω!");
          return;
        }

        showLoading(true);

        try {
          const response = await fetch(
            `https://loyalty-api.p-h.app/api/v3/RegistrationPlugin/${authToken}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                OrganizationId: authToken,
                OrganizationName: "PHcrmBalanceBot",
              }),
            }
          );

          const data = await response.json();

          if (response.status === 200 && data.Status === 1) {
            isRegistered = true;
            authSection.style.display = "none";
            mainSection.style.display = "block";
          } else {
            alert(data.ErrorMessage || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂");
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API");
        } finally {
          showLoading(false);
        }
      }

      async function checkOrganizationRegistration() {
        try {
          const response = await fetch(
            `https://loyalty-api.p-h.app/api/v3/RegistrationPlugin/${authToken}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                OrganizationId: authToken,
                OrganizationName: "PHcrmBalanceBot",
              }),
            }
          );

          const data = await response.json();
          isRegistered = response.status === 200 && data.Status === 1;
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
        }
      }

      function toggleQR() {
        const scannerContainer = document.getElementById('scannerContainer');
        scannerContainer.classList.add('active');

        if (!html5QrcodeScanner) {
          html5QrcodeScanner = new Html5Qrcode("reader", true);
        }

        const config = {
          fps: 10,
          qrbox: (viewfinderWidth, viewfinderHeight) => {
            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            let qrboxSize = Math.floor(minEdge * 0.8);
            qrboxSize = Math.max(qrboxSize, 200);
            qrboxSize = Math.min(qrboxSize, 300);
            return {
                width: qrboxSize,
                height: qrboxSize
            };
          },
          aspectRatio: 1.0,
          rememberLastUsedCamera: true
        };

        html5QrcodeScanner.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanFailure
        ).catch(err => {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä:", err);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞. –û—à–∏–±–∫–∞: " + err);
          closeScanner();
        });
      }

      function closeScanner() {
        if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
          html5QrcodeScanner.stop().then(() => {
            const scannerContainer = document.getElementById('scannerContainer');
            scannerContainer.classList.remove('active');
            console.log("–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
          }).catch(err => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–∫–∞–Ω–µ—Ä–∞:", err);
            const scannerContainer = document.getElementById('scannerContainer');
            scannerContainer.classList.remove('active');
          });
        } else {
            const scannerContainer = document.getElementById('scannerContainer');
            scannerContainer.classList.remove('active');
        }
      }

      function onScanSuccess(decodedText, decodedResult) {
        console.log("QR Code detected:", decodedText);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ 6 —Ü–∏—Ñ—Ä
        if (/^\d{6}$/.test(decodedText)) {
          const searchInput = document.getElementById("searchInput");
          searchInput.value = decodedText;
          searchClient(decodedText);
          closeScanner();
        } else {
          alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è 6 —Ü–∏—Ñ—Ä.");
        }
      }

      function onScanFailure(error) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        console.warn(`QR scan error: ${error}`);
      }

      async function searchClient(input = null) {
        const searchInput = document.getElementById("searchInput");
        const query = input || searchInput.value.trim();

        if (!query) {
          alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞!");
          return;
        }

        showLoading(true);
        resultCard.innerHTML = "";

        try {
          // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ CardNumber
          let response = await fetch(
            `https://loyalty-api.p-h.app/api/v3/GuestInfo/${authToken}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ CardNumber: query }),
            }
          );

          let data = await response.json();

          if (data.Status !== 1) {
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ CardNumber, –∏—â–µ–º –ø–æ Phone
            response = await fetch(
              `https://loyalty-api.p-h.app/api/v3/GuestInfo/${authToken}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ Phone: query }),
              }
            );

            data = await response.json();
          }

          if (data.Status === 1) {
            resultCard.innerHTML = `
            <h3>üë§ –ö–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω</h3>
            <p>–§–ò–û: ${data.Lastname || ""} ${data.Firstname || ""} ${
              data.MiddleName || ""
            }</p>
            <p>üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${data.Phone || ""}</p>
            <p>üí≥ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: ${data.CardNumber || ""}</p>
            <p>üéÅ –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${data.BonusBalance || 0}</p>
            <p>üí∞ –î–µ–ø–æ–∑–∏—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${data.DepositBalance || 0}</p>
            <p>üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π: ${data.LoyaltyLevel || "–ë–µ–∑ —É—Ä–æ–≤–Ω—è"}</p>
          `;
          } else {
            resultCard.innerHTML = `<p>‚ö†Ô∏è ${
              data.ErrorMessage || "–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            }</p>`;
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ API:", error);
          resultCard.innerHTML = "<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API.</p>";
        } finally {
          showLoading(false);
        }
      }

      function showLoading(show) {
        const buttons = document.querySelectorAll("button");
        buttons.forEach((btn) => {
          if (!btn.classList.contains("close-scanner")) {
            btn.disabled = show;
            if (show) {
              btn.dataset.originalText = btn.textContent;
              btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            } else {
              btn.textContent = btn.dataset.originalText || btn.textContent;
            }
          }
        });
      }
    </script>
  </body>
</html>
