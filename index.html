<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>PH CRM Balance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <style>
      :root {
        --primary-color: #1e90ff;
        --bg-color: #121212;
        --text-color: #ffffff;
        --card-bg: #1e1e1e;
        --border-radius: 12px;
        --keyboard-height: 0px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Roboto, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding-bottom: var(--keyboard-height);
      }

      .container {
        padding: 16px;
        flex: 1;
        overflow-y: auto;
        scroll-behavior: smooth;
      }

      h2 {
        text-align: center;
        margin-top: 0;
        color: var(--primary-color);
      }

      .auth-section,
      .main-section {
        display: none;
      }

      .input-group {
        margin-bottom: 16px;
        position: relative;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        padding-right: 50px;
        border: none;
        border-radius: var(--border-radius);
        background-color: var(--card-bg);
        color: var(--text-color);
        font-size: 16px;
      }

      .search-input-container {
        position: relative;
        width: 100%;
      }

      .qr-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: var(--primary-color);
        font-size: 28px;
        padding: 10px;
        border-radius: 50%;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
      }

      .qr-icon:hover {
        background-color: rgba(30, 144, 255, 0.1);
      }

      button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: var(--border-radius);
        background-color: var(--primary-color);
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      button:disabled {
        background-color: #888;
        cursor: not-allowed;
      }

      .result-card {
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 16px;
        margin-top: 20px;
        display: none;
      }

      .result-card p {
        margin: 8px 0;
      }

      .qr-button {
        background-color: #2ecc71;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 50px;
      }

      .scanner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-color);
        z-index: 1000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
      }

      .scanner-container.active {
        display: flex;
      }

      .close-scanner {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        padding: 8px;
        color: white;
        font-size: 24px;
        border: none;
        cursor: pointer;
        z-index: 1001;
      }

      #reader {
        width: 90%;
        max-width: 400px;
        min-height: 200px;
        margin: 20px auto;
        background-color: #333;
        border: 1px solid #555;
        overflow: hidden;
      }

      #reader video {
        width: 100% !important;
        height: auto !important;
        border-radius: var(--border-radius);
      }

      .order-section {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #333;
        position: relative;
      }

      .order-section .input-group {
        margin-bottom: 10px;
      }
      
      .order-section label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ */
      .scroll-space {
        height: 300px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
        opacity: 0;
        pointer-events: none;
        position: relative;
        z-index: -1;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ */
      hr {
        border: none;
        height: 1px;
        background-color: rgba(255, 255, 255, 0.1);
        margin: 15px 0;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—É–º–±–ª–µ—Ä–æ–≤ */
      .toggle-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }

      input:checked + .toggle-slider {
        background-color: var(--primary-color);
      }

      input:checked + .toggle-slider:before {
        transform: translateX(26px);
      }

      .toggle-label {
        font-size: 14px;
        color: var(--text-color);
      }

      .amount-input {
        display: none;
        margin-top: 10px;
        margin-bottom: 15px;
        background-color: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .amount-input.visible {
        display: block;
      }

      .amount-input label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-color);
        font-size: 14px;
      }

      .amount-input input {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .amount-input input:focus {
        border-color: var(--primary-color);
        outline: none;
      }

      .create-order-button {
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .close-order-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è iOS */
      @supports (-webkit-touch-callout: none) {
        .container {
          padding-bottom: calc(16px + var(--keyboard-height));
        }

        .order-section {
          padding-bottom: 100px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="auth-section" id="authSection">
        <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <div class="input-group">
          <input type="text" id="authToken" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω" />
        </div>
        <button onclick="registerOrganization()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>

      <div class="main-section" id="mainSection">
        <h2>–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è</h2>

        <!-- –ï–¥–∏–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div class="input-group">
          <div class="search-input-container">
            <input
              type="text"
              id="searchInput"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
              inputmode="numeric"
              pattern="[0-9]*"
            />
            <span class="qr-icon" onclick="toggleQR()">
              <span class="iconify" data-icon="f7:qrcode-viewfinder"></span>
            </span>
          </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
        <button onclick="searchClient()">üîç –ü–æ–∏—Å–∫</button>

        <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
        <div class="result-card" id="resultCard"></div>
        <div class="order-section" id="orderSection" style="display: none;">
          <h3>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>
          <div class="input-group">
            <label for="orderSum">–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</label>
            <input 
              type="number" 
              id="orderSum" 
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" 
              inputmode="decimal"
              pattern="[0-9]*"
              step="0.01"
              min="0"
              onfocus="scrollToInput(this)"
              onblur="handleInputBlur()"
            />
          </div>
          <button onclick="calculateDiscount()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–∞–∫–∞–∑</button>
          <!-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–≤–∏–¥–∏–º–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ -->
          <div class="scroll-space"></div>
        </div>
        <!-- –í—ã–Ω–µ—Å–ª–∏ discountResultCard –∑–∞ –ø—Ä–µ–¥–µ–ª—ã orderSection –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ -->
        <div class="result-card" id="discountResultCard" style="display: none; margin-top: 10px;"></div>
      </div>
    </div>

    <div class="scanner-container" id="scannerContainer">
      <button class="close-scanner" onclick="closeScanner()">‚úï</button>
      <div id="reader"></div>
    </div>

    <script>
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
      Telegram.WebApp.ready();

      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ URL
      const urlParams = new URLSearchParams(window.location.search);
      let authToken = urlParams.get("token");
      let isRegistered = false;

      const authSection = document.getElementById("authSection");
      const mainSection = document.getElementById("mainSection");
      const resultCard = document.getElementById("resultCard");
      const orderSection = document.getElementById("orderSection");
      const discountResultCard = document.getElementById("discountResultCard");

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞
      if (!authToken) {
        authSection.style.display = "block";
      } else {
        mainSection.style.display = "block";
        checkOrganizationRegistration();
      }

      let html5QrcodeScanner = null;
      let currentClientId = null;
      let currentClientIdentifier = null; // To store card/phone for re-fetching
      let lastGetDiscountResponse = null;
      let currentOrderDetails = {};

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      async function sendLog(action, details = {}) {
        try {
          // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp
          const user = Telegram.WebApp.initDataUnsafe?.user;
          if (!user) {
            console.warn('User data not available for logging');
            return;
          }

          const logData = {
            user_id: user.id,
            username: user.username || 'unknown',
            action: action,
            details: details
          };

          console.log('Sending log:', logData);

          // –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTPS
          const response = await fetch(`https://185.125.217.66/api/log`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(logData)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log('Log sent successfully:', result);
        } catch (error) {
          console.error('Error sending log:', error);
        }
      }

      async function registerOrganization() {
        const tokenInput = document.getElementById("authToken");
        authToken = tokenInput.value.trim();

        if (!authToken) {
          alert("–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω!");
          return;
        }

        showLoading(true);
        await sendLog('register_organization_attempt', { token: authToken.substring(0, 5) + '...' });

        try {
          const response = await fetch(
            `https://loyalty-api.p-h.app/api/v3/RegistrationPlugin/${authToken}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                OrganizationId: authToken,
                OrganizationName: "PHcrmBalanceBot",
              }),
            }
          );

          const data = await response.json();

          if (response.status === 200 && data.Status === 1) {
            isRegistered = true;
            authSection.style.display = "none";
            mainSection.style.display = "block";
            await sendLog('register_organization_success');
          } else {
            await sendLog('register_organization_error', { error: data.ErrorMessage });
            alert(data.ErrorMessage || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂");
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
          await sendLog('register_organization_error', { error: error.message });
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API");
        } finally {
          showLoading(false);
        }
      }

      async function checkOrganizationRegistration() {
        try {
          const response = await fetch(
            `https://loyalty-api.p-h.app/api/v3/RegistrationPlugin/${authToken}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                OrganizationId: authToken,
                OrganizationName: "PHcrmBalanceBot",
              }),
            }
          );

          const data = await response.json();
          isRegistered = response.status === 200 && data.Status === 1;
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
        }
      }

      function toggleQR() {
        console.log("Starting QR scanner...");
        const scannerContainer = document.getElementById('scannerContainer');
        scannerContainer.classList.add('active');

        if (!html5QrcodeScanner) {
          try {
            html5QrcodeScanner = new Html5Qrcode("reader", true);
            console.log("Html5Qrcode created successfully");
          } catch (err) {
            console.error("Error creating QR scanner:", err);
            alert("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞: " + err);
            return;
          }
        }

        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0,
          rememberLastUsedCamera: true
        };

        console.log("Starting camera...");
        html5QrcodeScanner.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanFailure
        ).catch(err => {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä:", err);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞. –û—à–∏–±–∫–∞: " + err);
          closeScanner();
        });
      }

      function closeScanner() {
        if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
          html5QrcodeScanner.stop().then(() => {
            const scannerContainer = document.getElementById('scannerContainer');
            scannerContainer.classList.remove('active');
            console.log("–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
          }).catch(err => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–∫–∞–Ω–µ—Ä–∞:", err);
            const scannerContainer = document.getElementById('scannerContainer');
            scannerContainer.classList.remove('active');
          });
        } else {
          const scannerContainer = document.getElementById('scannerContainer');
          scannerContainer.classList.remove('active');
        }
      }

      function onScanSuccess(decodedText, decodedResult) {
        console.log("QR Code detected:", decodedText);
        
        if (decodedText && decodedText.trim() !== "") {
          const searchInput = document.getElementById("searchInput");
          searchInput.value = decodedText.trim();
          searchClient(decodedText.trim());
          closeScanner();
        } else {
          alert("QR-–∫–æ–¥ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
        }
      }

      function onScanFailure(error) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        console.warn(`QR scan error: ${error}`);
      }

      async function searchClient(input = null) {
        const searchInput = document.getElementById("searchInput");
        const query = input || searchInput.value.trim();

        if (!query) {
          alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞!");
          return;
        }

        currentClientIdentifier = query;
        showLoading(true);
        resultCard.innerHTML = "";
        resultCard.style.display = "none";
        orderSection.style.display = "none";
        discountResultCard.style.display = "none";

        // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
        sendLog('search_client_attempt', { query: query });

        try {
          // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ CardNumber
          let response = await fetch(
            `https://loyalty-api.p-h.app/api/v3/GuestInfo/${authToken}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ CardNumber: query }),
            }
          );

          let data = await response.json();

          if (data.Status !== 1) {
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ CardNumber, –∏—â–µ–º –ø–æ Phone
            response = await fetch(
              `https://loyalty-api.p-h.app/api/v3/GuestInfo/${authToken}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ Phone: query }),
              }
            );

            data = await response.json();
          }

          if (data.Status === 1) {
            currentClientId = data.ClientId;
            // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
            sendLog('search_client_success', {
              client_id: data.ClientId,
              found_by: data.CardNumber ? 'card' : 'phone'
            });
            resultCard.innerHTML = `
            <h3>–ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω</h3>
            <p>üë§ –§–ò–û: ${data.LastName || ""} ${data.FirstName || ""} ${data.MiddleName || ""}</p>
            <p>üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${data.Phone || ""}</p>
            <p>üí≥ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: ${data.CardNumber || ""}</p>
            <hr />
            <p>üéÅ –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${data.BonusBalance || 0}</p>
            <p>üí∞ –î–µ–ø–æ–∑–∏—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${data.DepositBalance || 0}</p>
            <hr />
            <p>üîÜ –£—Ä–æ–≤–µ–Ω—å: ${data.LoyaltyLevel || "–ë–µ–∑ —É—Ä–æ–≤–Ω—è"}</p>
          `;
            resultCard.style.display = "block";
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –±–ª–æ–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            const createOrderButton = document.createElement('button');
            createOrderButton.className = 'create-order-button';
            createOrderButton.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑';
            createOrderButton.onclick = showCreateOrderForm;
            resultCard.after(createOrderButton);
          } else {
            currentClientId = null;
            // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
            sendLog('search_client_error', { error: data.ErrorMessage });
            resultCard.innerHTML = `<p>‚ö†Ô∏è ${data.ErrorMessage || "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω"}</p>`;
            resultCard.style.display = "block";
          }
        } catch (error) {
          currentClientId = null;
          console.error("–û—à–∏–±–∫–∞ API:", error);
          // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
          sendLog('search_client_error', { error: error.message });
          resultCard.innerHTML = "<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API.</p>";
          resultCard.style.display = "block";
        } finally {
          showLoading(false);
        }
      }

      function showCreateOrderForm() {
        if (!currentClientId) {
          alert("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –≥–æ—Å—Ç—è!");
          return;
        }
        orderSection.style.display = "block";
        document.getElementById("orderSum").value = "";
        
        discountResultCard.innerHTML = "";
        discountResultCard.style.display = "none";

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –≤ –∫–æ–Ω–µ—Ü —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(() => {
          window.scrollTo({
            top: document.body.scrollHeight,
            behavior: 'smooth'
          });
        }, 100);
      }

      function generateUUID() { // Simple UUID generator
        return 'xxxx-xxxx-xxxx-xxxx-xxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      async function calculateDiscount() {
        if (!currentClientId) {
          alert("–ì–æ—Å—Ç—å –Ω–µ –≤—ã–±—Ä–∞–Ω.");
          return;
        }

        const orderSumInput = document.getElementById("orderSum");
        const orderSum = parseFloat(orderSumInput.value);

        if (isNaN(orderSum) || orderSum <= 0) {
          alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞.");
          return;
        }

        // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ scroll-space
        const scrollSpace = document.querySelector('.scroll-space');
        if (scrollSpace) {
          scrollSpace.style.display = 'none';
        }

        showLoading(true);
        discountResultCard.innerHTML = "";
        discountResultCard.style.display = "none";

        // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
        sendLog('calculate_discount_attempt', {
          client_id: currentClientId,
          order_sum: orderSum
        });

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏
        const priceWithDiscount = orderSum;

        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ API
        currentOrderDetails = {
          OrganizationId: authToken,
          ClientId: currentClientId,
          ParentOrderId: generateUUID(),
          OrderId: generateUUID(),
          OrderNumber: Date.now(),
          OrderSum: orderSum,
          OrderSumWithDiscount: priceWithDiscount,
          Order: [
            {
              ProductId: "1111-PHPH-2222-BONS-3333",
              ProductName: "–¢–µ–ª–µ–≥—Ä–∞–º –ª–æ—è–ª—å–Ω–æ—Å—Ç—å",
              Price: orderSum,
              PriceWithDiscount: priceWithDiscount,
              Amount: 1
            }
          ]
        };
        currentOrderDetails.ParentOrderId = currentOrderDetails.OrderId;

        try {
          const response = await fetch(
            `https://loyalty-api.p-h.app/api/v3/GetDiscount/${authToken}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(currentOrderDetails),
            }
          );
          lastGetDiscountResponse = await response.json();

          console.log("GetDiscount response:", JSON.stringify(lastGetDiscountResponse, null, 2));

          if (response.status === 200 && lastGetDiscountResponse.Status === 1) {
            // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
            sendLog('calculate_discount_success', {
              client_id: currentClientId,
              discount: lastGetDiscountResponse.SumDiscount,
              max_bonus: lastGetDiscountResponse.MaxBonus,
              max_deposit: lastGetDiscountResponse.MaxDeposit
            });
            currentOrderDetails.getDiscountResponse = lastGetDiscountResponse;
            const apiDiscount = parseFloat(lastGetDiscountResponse.SumDiscount || 0);
            const sumAfterDiscount = orderSum - apiDiscount;

            discountResultCard.innerHTML = `
              <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞</h4>
              <p>üéØ –°–∫–∏–¥–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é: ${apiDiscount.toFixed(2)} —Ä—É–±.</p>
              <p>üéÅ –ú–∞–∫—Å. —Å–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤: ${lastGetDiscountResponse.MaxBonus || 0}</p>
              <p>üí∞ –ú–∞–∫—Å. —Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞: ${lastGetDiscountResponse.MaxDeposit || 0}</p>

              <div class="close-order-section">
                <div class="toggle-container">
                  <label class="toggle-switch">
                    <input type="checkbox" id="bonusToggle" onchange="toggleAmountInput('bonus')">
                    <span class="toggle-slider"></span>
                  </label>
                  <span class="toggle-label">–°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å—ã</span>
                </div>
                <div id="bonusAmountInput" class="amount-input">
                  <label for="bonusWriteOff">–°—É–º–º–∞ –±–æ–Ω—É—Å–æ–≤ (–º–∞–∫—Å: ${lastGetDiscountResponse.MaxBonus || 0}):</label>
                  <input 
                    type="number" 
                    id="bonusWriteOff" 
                    placeholder="0" 
                    value="${lastGetDiscountResponse.MaxBonus || 0}" 
                    max="${lastGetDiscountResponse.MaxBonus || 0}" 
                    min="0"
                    inputmode="decimal"
                    pattern="[0-9]*"
                    step="0.01"
                    onclick="this.value=''"
                    oninput="updateFinalSum()"
                  />
                </div>

                <div class="toggle-container">
                  <label class="toggle-switch">
                    <input type="checkbox" id="depositToggle" onchange="toggleAmountInput('deposit')">
                    <span class="toggle-slider"></span>
                  </label>
                  <span class="toggle-label">–°–ø–∏—Å–∞—Ç—å –¥–µ–ø–æ–∑–∏—Ç</span>
                </div>
                <div id="depositAmountInput" class="amount-input">
                  <label for="depositWriteOff">–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ (–º–∞–∫—Å: ${lastGetDiscountResponse.MaxDeposit || 0}):</label>
                  <input 
                    type="number" 
                    id="depositWriteOff" 
                    placeholder="0" 
                    value="${lastGetDiscountResponse.MaxDeposit || 0}" 
                    max="${lastGetDiscountResponse.MaxDeposit || 0}" 
                    min="0"
                    inputmode="decimal"
                    pattern="[0-9]*"
                    step="0.01"
                    onclick="this.value=''"
                    oninput="updateFinalSum()"
                  />
                </div>
                <div id="finalSumDisplay" style="margin: 20px 0; padding: 15px; background-color: rgba(255, 255, 255, 0.05); border-radius: var(--border-radius);">
                  <p>üíµ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: ${sumAfterDiscount.toFixed(2)} —Ä—É–±.</p>
                </div>
                <button onclick="closeOrder()">–ó–∞–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑</button>
              </div>
            `;
          } else {
            // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
            sendLog('calculate_discount_error', {
              error: lastGetDiscountResponse.ErrorMessage
            });
            discountResultCard.innerHTML = `<p>‚ö†Ô∏è ${lastGetDiscountResponse.ErrorMessage || "–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∑–∞–∫–∞–∑–∞"}</p>`;
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ API GetDiscount:", error);
          // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
          sendLog('calculate_discount_error', { error: error.message });
          discountResultCard.innerHTML = "<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π.</p>";
        } finally {
          discountResultCard.style.display = "block";
          showLoading(false);
        }
      }

      function showLoading(show) {
        const buttons = document.querySelectorAll("button");
        buttons.forEach((btn) => {
          if (!btn.classList.contains("close-scanner")) {
            btn.disabled = show;
            if (show) {
              btn.dataset.originalText = btn.textContent;
              btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            } else {
              btn.textContent = btn.dataset.originalText || btn.textContent;
            }
          }
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ (UTC+3)
      function getMoscowDateTime() {
        const now = new Date();
        
        // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏ (UTC+3)
        const moscowTime = new Date(now.getTime() + 3 * 60 * 60 * 1000);
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ —Å—Ç—Ä–æ–∫—É YYYY-MM-DD HH:MM:SS –¥–ª—è API
        const year = moscowTime.getUTCFullYear();
        const month = String(moscowTime.getUTCMonth() + 1).padStart(2, '0');
        const day = String(moscowTime.getUTCDate()).padStart(2, '0');
        const hours = String(moscowTime.getUTCHours()).padStart(2, '0');
        const minutes = String(moscowTime.getUTCMinutes()).padStart(2, '0');
        const seconds = String(moscowTime.getUTCSeconds()).padStart(2, '0');
        
        // –§–æ—Ä–º–∞—Ç –¥–ª—è API
        const apiDateTimeFormat = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        
        return {
          apiFormat: apiDateTimeFormat,
          dateStr: `${day}.${month}.${year}`,
          timeStr: `${hours}:${minutes}:${seconds}`
        };
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —á–µ–∫–∞
      function generateReceipt(orderData, discountResponse, bonusWriteOff, depositWriteOff, finalSum) {
        // –ü–æ–ª—É—á–∞–µ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
        const moscowTime = getMoscowDateTime();
        const dateStr = moscowTime.dateStr;
        const timeStr = moscowTime.timeStr;
        
        const apiDiscount = parseFloat(discountResponse.SumDiscount || 0);
        const loyaltyLevel = discountResponse.LoyaltyLevel || "–ù–µ —É–∫–∞–∑–∞–Ω";
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        const orderNumber = typeof orderData.OrderNumber === 'number' 
          ? '#' + orderData.OrderNumber.toString().padStart(6, '0')
          : '#' + orderData.OrderNumber;
        
        let receiptText = `
===== –ß–ï–ö –ó–ê–ö–ê–ó–ê =====
–î–∞—Ç–∞: ${dateStr}
–í—Ä–µ–º—è: ${timeStr}
–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${orderNumber}
------------------------
–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞: ${orderData.OrderSum.toFixed(2)} ‚ÇΩ
`;

        if (apiDiscount > 0) {
          receiptText += `–°–∫–∏–¥–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é (${loyaltyLevel}): ${apiDiscount.toFixed(2)} ‚ÇΩ\n`;
        }
        
        if (bonusWriteOff > 0) {
          receiptText += `–°–ø–∏—Å–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤: ${bonusWriteOff.toFixed(2)} ‚ÇΩ\n`;
        }
        
        if (depositWriteOff > 0) {
          receiptText += `–°–ø–∏—Å–∞–Ω–æ —Å –¥–µ–ø–æ–∑–∏—Ç–∞: ${depositWriteOff.toFixed(2)} ‚ÇΩ\n`;
        }
        
        receiptText += `------------------------
–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï: ${finalSum.toFixed(2)} ‚ÇΩ
========================
`;

        return receiptText;
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞ –≤ Telegram –±–æ—Ç–∞
      async function sendReceiptToBot(receiptText) {
        try {
          console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ–∫–∞ –≤ –±–æ—Ç–∞...");
          
          if (!window.Telegram || !window.Telegram.WebApp) {
            throw new Error("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
          }

          const payload = {
            action: 'receipt',
            text: receiptText,
            orderId: currentOrderDetails.OrderId,
            token: authToken,
            orderSum: currentOrderDetails.OrderSum
          };
          
          console.log("–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:", payload);
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTPS
          const apiResponse = await fetch(`https://185.125.217.66/api/receipt`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (!apiResponse.ok) {
            throw new Error(`API error! status: ${apiResponse.status}`);
          }

          const apiResult = await apiResponse.json();
          console.log("API response:", apiResult);

          // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ API, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ WebApp
          Telegram.WebApp.sendData(JSON.stringify(payload));
          console.log("–ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ WebApp");
          
          return true;
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ–∫–∞:", error);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ–∫–∞: " + error.message);
          return false;
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é sendReceipt –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è async/await
      async function sendReceipt(encodedReceiptText) {
        const receiptText = decodeURIComponent(encodedReceiptText);
        console.log("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ–∫–∞...");
        
        await sendLog('send_receipt_attempt', {
          order_id: currentOrderDetails.OrderId
        });
        
        const success = await sendReceiptToBot(receiptText);
        
        if (success) {
          await sendLog('send_receipt_success', {
            order_id: currentOrderDetails.OrderId
          });
          console.log("–ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
        } else {
          await sendLog('send_receipt_error', {
            error: 'Failed to send receipt'
          });
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–µ–∫–æ–º –∏ —Å–±—Ä–æ—Å–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      function resetApp() {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
        currentClientId = null;
        currentClientIdentifier = null;
        lastGetDiscountResponse = null;
        currentOrderDetails = {};
        
        // –û—á–∏—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã UI
        resultCard.innerHTML = "";
        discountResultCard.innerHTML = "";
        orderSection.style.display = "none";
        document.getElementById("searchInput").value = "";

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
        const scrollSpace = document.querySelector('.scroll-space');
        if (scrollSpace) {
          scrollSpace.classList.remove('hidden');
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ–∫–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
      function copyReceiptToClipboard(encodedReceiptText) {
        const receiptText = decodeURIComponent(encodedReceiptText);
        
        try {
          // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
          const tempElement = document.createElement('textarea');
          tempElement.value = receiptText;
          document.body.appendChild(tempElement);
          tempElement.select();
          document.execCommand('copy');
          document.body.removeChild(tempElement);
          
          // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          alert('–ß–µ–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —á–µ–∫–∞:', error);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é –≤—ã–¥–µ–ª–∏—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç.');
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
      function updateKeyboardHeight() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω—É—é –≤—ã—Å–æ—Ç—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã iOS
          document.documentElement.style.setProperty('--keyboard-height', '300px');
        }
      }

      // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
      window.addEventListener('load', updateKeyboardHeight);
      window.addEventListener('resize', updateKeyboardHeight);
      window.addEventListener('orientationchange', updateKeyboardHeight);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é scrollToInput
      function scrollToInput(inputElement) {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
          // –î–ª—è iOS –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø
          setTimeout(() => {
            const offset = inputElement.getBoundingClientRect().top + window.pageYOffset - 100;
            window.scrollTo({
              top: offset,
              behavior: 'smooth'
            });
          }, 300);
        } else {
          // –î–ª—è –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
          setTimeout(() => {
            inputElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
      function handleInputBlur() {
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∫–Ω–æ–ø–∫–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏"
        const calculateButton = document.querySelector('button[onclick="calculateDiscount()"]');
        if (calculateButton) {
          setTimeout(() => {
            calculateButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
      document.addEventListener('click', function(event) {
        const orderSumInput = document.getElementById('orderSum');
        if (orderSumInput && !orderSumInput.contains(event.target)) {
          orderSumInput.blur();
        }
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ì–æ—Ç–æ–≤–æ" –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
      document.getElementById('orderSum').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur();
          handleInputBlur();
        }
      });

      function toggleAmountInput(type) {
        const inputContainer = document.getElementById(`${type}AmountInput`);
        const toggle = document.getElementById(`${type}Toggle`);
        const input = document.getElementById(`${type}WriteOff`);
        
        if (toggle.checked) {
          inputContainer.classList.add('visible');
          input.value = lastGetDiscountResponse[`Max${type.charAt(0).toUpperCase() + type.slice(1)}`] || 0;
        } else {
          inputContainer.classList.remove('visible');
          input.value = 0;
        }
        updateFinalSum();
      }

      function updateFinalSum() {
        const apiDiscount = parseFloat(lastGetDiscountResponse.SumDiscount || 0);
        const sumAfterDiscount = currentOrderDetails.OrderSum - apiDiscount;
        
        const bonusToggle = document.getElementById("bonusToggle");
        const depositToggle = document.getElementById("depositToggle");
        const bonusWriteOff = bonusToggle.checked ? parseFloat(document.getElementById("bonusWriteOff").value) || 0 : 0;
        const depositWriteOff = depositToggle.checked ? parseFloat(document.getElementById("depositWriteOff").value) || 0 : 0;

        const finalSum = sumAfterDiscount - bonusWriteOff - depositWriteOff;
        const finalSumDisplay = document.getElementById("finalSumDisplay");
        if (finalSumDisplay) {
          finalSumDisplay.innerHTML = `<p>üíµ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: ${finalSum.toFixed(2)} —Ä—É–±.</p>`;
        }
      }

      async function closeOrder() {
        if (!lastGetDiscountResponse || !currentOrderDetails.OrderId) {
          alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –∑–∞–∫–∞–∑ —Å–Ω–∞—á–∞–ª–∞.");
          return;
        }

        const bonusToggle = document.getElementById("bonusToggle");
        const depositToggle = document.getElementById("depositToggle");
        const bonusWriteOff = bonusToggle.checked ? parseFloat(document.getElementById("bonusWriteOff").value) || 0 : 0;
        const depositWriteOff = depositToggle.checked ? parseFloat(document.getElementById("depositWriteOff").value) || 0 : 0;

        if (bonusToggle.checked && (bonusWriteOff < 0 || bonusWriteOff > (lastGetDiscountResponse.MaxBonus || 0))) {
            alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤. –î–æ—Å—Ç—É–ø–Ω–æ: ${lastGetDiscountResponse.MaxBonus || 0}`);
            return;
        }
        if (depositToggle.checked && (depositWriteOff < 0 || depositWriteOff > (lastGetDiscountResponse.MaxDeposit || 0))) {
            alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å –¥–µ–ø–æ–∑–∏—Ç–∞. –î–æ—Å—Ç—É–ø–Ω–æ: ${lastGetDiscountResponse.MaxDeposit || 0}`);
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
        const moscowTime = getMoscowDateTime();
        
        const closeOrderPayload = {
          OrganizationId: String(authToken),
          ParentOrderId: currentOrderDetails.ParentOrderId,
          OrderId: currentOrderDetails.OrderId,
          OrderNumber: currentOrderDetails.OrderNumber,
          OrderDate: getMoscowDateTime().apiFormat,
          OrderSum: currentOrderDetails.OrderSum,
          OrderSumWithDiscount: currentOrderDetails.OrderSumWithDiscount,
          ClientId: parseInt(currentClientId, 10),
          DepositClientId: parseInt(currentClientId, 10),
          BonusWriteOff: bonusWriteOff,
          DepositWriteOff: depositWriteOff,
          Order: JSON.parse(JSON.stringify(currentOrderDetails.Order))
        };
        
        if (closeOrderPayload.getDiscountResponse) {
          delete closeOrderPayload.getDiscountResponse;
        }

        showLoading(true);
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è CloseOrder:", JSON.stringify(closeOrderPayload, null, 2));
        discountResultCard.innerHTML = "–ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞...";

        // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
        sendLog('close_order_attempt', {
          order_id: currentOrderDetails.OrderId,
          bonus_write_off: bonusWriteOff,
          deposit_write_off: depositWriteOff
        });

        try {
          const response = await fetch(
            `https://loyalty-api.p-h.app/api/v3/CloseOrder/${authToken}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(closeOrderPayload),
            }
          );
          const closeOrderData = await response.json();

          if (response.status === 200 && closeOrderData.Status === 1) {
            // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
            sendLog('close_order_success', {
              order_id: currentOrderDetails.OrderId,
              bonus_add: closeOrderData.BonusAdd,
              bonus_balance: closeOrderData.BonusBalance,
              deposit_add: closeOrderData.DepositAdd,
              deposit_balance: closeOrderData.DepositBalance
            });
            const apiDiscount = parseFloat(lastGetDiscountResponse.SumDiscount || 0);
            const finalDisplaySum = currentOrderDetails.OrderSum - apiDiscount - bonusWriteOff - depositWriteOff;
            
            const formattedOrderNumber = typeof currentOrderDetails.OrderNumber === 'number' 
              ? '#' + currentOrderDetails.OrderNumber.toString().padStart(6, '0')
              : '#' + currentOrderDetails.OrderNumber;
            
            const receiptText = generateReceipt(
              currentOrderDetails,
              lastGetDiscountResponse,
              bonusWriteOff,
              depositWriteOff,
              finalDisplaySum
            );
            
            discountResultCard.innerHTML = `
              <h4>‚úÖ –ó–∞–∫–∞–∑ ${formattedOrderNumber} —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç!</h4>
              <p>üìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${closeOrderData.Message || "–£—Å–ø–µ—à–Ω–æ"}</p>
              <p>üéÅ –°–ø–∏—Å–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤: ${bonusWriteOff}</p>
              <p>üí∞ –°–ø–∏—Å–∞–Ω–æ —Å –¥–µ–ø–æ–∑–∏—Ç–∞: ${depositWriteOff}</p>
              <p>üíµ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: ${finalDisplaySum.toFixed(2)} —Ä—É–±.</p>
              <div style="margin-top: 15px;">
                <h4>üìÑ –ß–µ–∫ –∑–∞–∫–∞–∑–∞</h4>
                <pre style="background-color: #f5f5f5; color: #333; padding: 15px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; cursor: pointer;" onclick="copyReceiptToClipboard('${encodeURIComponent(receiptText)}')">${receiptText}</pre>
                <button onclick="resetApp()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button onclick="sendReceipt('${encodeURIComponent(receiptText)}')" style="margin-top: 10px; background-color: #4285F4;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫ –≤ –±–æ—Ç–∞</button>
              </div>
            `;
            orderSection.style.display = "none";
            discountResultCard.style.display = "block";
            mainSection.style.display = "block";
            resultCard.style.display = "block";
            discountResultCard.scrollIntoView({ behavior: 'smooth' });
          } else {
            // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
            sendLog('close_order_error', {
              error: closeOrderData.ErrorMessage
            });
            discountResultCard.innerHTML = `<p>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞: ${closeOrderData.ErrorMessage || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}</p>`;
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ API CloseOrder:", error);
          // –ù–ï –∂–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞
          sendLog('close_order_error', { error: error.message });
          discountResultCard.innerHTML = "<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–∫–∞–∑–∞.</p>";
        } finally {
          showLoading(false);
        }
      }
    </script>
  </body>
</html>
