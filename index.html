<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>PH CRM Balance</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root {
      --primary-color: #1E90FF;
      --bg-color: #121212;
      --text-color: #ffffff;
      --card-bg: #1e1e1e;
      --border-radius: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    h2 {
      text-align: center;
      margin-top: 0;
      color: var(--primary-color);
    }

    .auth-section,
    .main-section {
      display: none;
    }

    .input-group {
      margin-bottom: 16px;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-color);
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary-color);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:disabled {
      background-color: #888;
      cursor: not-allowed;
    }

    .result-card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px;
      margin-top: 20px;
    }

    .result-card p {
      margin: 8px 0;
    }

    .qr-button {
      background-color: #2ecc71;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50px;
    }

    #reader {
      display: none;
      width: 100%;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      background: black;
    }

    .scanner-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .close-scanner {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      padding: 8px;
      color: white;
      font-size: 24px;
      border: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="auth-section" id="authSection">
      <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
      <div class="input-group">
        <input type="text" id="authToken" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω" />
      </div>
      <button onclick="registerOrganization()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <div class="main-section" id="mainSection">
      <h2>üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</h2>
      
      <div class="input-group">
        <select id="searchType">
          <option value="phone">üì± –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É</option>
          <option value="card">üí≥ –ü–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã</option>
        </select>
      </div>

      <div class="input-group">
        <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ" />
      </div>

      <button class="qr-button" onclick="toggleQR()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
      <button onclick="searchClient()">üîç –ü–æ–∏—Å–∫</button>

      <div class="result-card" id="resultCard"></div>
    </div>
  </div>

  <div id="reader" class="scanner-container">
    <button class="close-scanner" onclick="toggleQR()">‚úï</button>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    Telegram.WebApp.ready();
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    let authToken = urlParams.get('token');
    let isRegistered = false;

    const authSection = document.getElementById('authSection');
    const mainSection = document.getElementById('mainSection');
    const resultCard = document.getElementById('resultCard');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞
    if (!authToken) {
      authSection.style.display = 'block';
    } else {
      mainSection.style.display = 'block';
      checkOrganizationRegistration();
    }

    async function registerOrganization() {
      const tokenInput = document.getElementById('authToken');
      authToken = tokenInput.value.trim();
      
      if (!authToken) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
        return;
      }

      showLoading(true);
      
      try {
        const response = await fetch(`https://loyalty-api.p-h.app/api/v3/RegistrationPlugin/${authToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            OrganizationId: authToken,
            OrganizationName: "PHcrmBalanceBot"
          })
        });

        const data = await response.json();
        
        if (response.status === 200 && data.Status === 1) {
          isRegistered = true;
          authSection.style.display = 'none';
          mainSection.style.display = 'block';
        } else {
          alert(data.ErrorMessage || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂');
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API');
      } finally {
        showLoading(false);
      }
    }

    async function checkOrganizationRegistration() {
      try {
        const response = await fetch(`https://loyalty-api.p-h.app/api/v3/RegistrationPlugin/${authToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            OrganizationId: authToken,
            OrganizationName: "PHcrmBalanceBot"
          })
        });

        const data = await response.json();
        isRegistered = response.status === 200 && data.Status === 1;
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
      }
    }

    async function toggleQR() {
      const reader = document.getElementById('reader');
      const isVisible = reader.style.display === 'block';
      
      if (!isVisible) {
        reader.style.display = 'block';
        try {
          const html5QrCode = new Html5Qrcode("reader");
          
          await html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            async (decodedText) => {
              reader.style.display = 'none';
              document.getElementById('searchInput').value = decodedText;
              searchClient(decodedText);
            },
            (errorMessage) => {
              console.warn("–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:", errorMessage);
              if (!errorMessage.includes("No code found")) {
                alert(`–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${errorMessage}`);
              }
            }
          );
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞:", error);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É');
        }
      } else {
        reader.style.display = 'none';
      }
    }

    async function searchClient(input = null) {
      const searchInput = document.getElementById('searchInput');
      const searchType = document.getElementById('searchType').value;
      const query = input || searchInput.value.trim();
      
      if (!query) {
        alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞!");
        return;
      }

      showLoading(true);
      resultCard.innerHTML = '';
      
      const body = {};
      if (searchType === 'phone') {
        if (!/^\d{10,14}$/.test(query)) {
          alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (10-14 —Ü–∏—Ñ—Ä)");
          showLoading(false);
          return;
        }
        body.Phone = query;
      } else {
        body.CardNumber = query;
      }

      try {
        const response = await fetch(`https://loyalty-api.p-h.app/api/v3/GuestInfo/${authToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();
        
        if (data.Status === 1) {
          resultCard.innerHTML = `
            <h3>üë§ –ö–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω</h3>
            <p>–§–ò–û: ${data.Lastname || ''} ${data.Firstname || ''} ${data.MiddleName || ''}</p>
            <p>üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${data.Phone || ''}</p>
            <p>üí≥ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: ${data.CardNumber || ''}</p>
            <p>üéÅ –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${data.BonusBalance || 0}</p>
            <p>üí∞ –î–µ–ø–æ–∑–∏—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${data.DepositBalance || 0}</p>
            <p>üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π: ${data.LoyaltyLevel || '–ë–µ–∑ —É—Ä–æ–≤–Ω—è'}</p>
          `;
        } else {
          resultCard.innerHTML = `<p>‚ö†Ô∏è ${data.ErrorMessage || '–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}</p>`;
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ API:", error);
        resultCard.innerHTML = "<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API.</p>";
      } finally {
        showLoading(false);
      }
    }

    function showLoading(show) {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.disabled = show;
        if (!btn.classList.contains('close-scanner')) {
          btn.textContent = show ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : btn.dataset.originalText || btn.textContent;
          btn.dataset.originalText = btn.dataset.originalText || btn.textContent;
        }
      });
    }
  </script>
</body>
</html>
