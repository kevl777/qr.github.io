<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrimeHill CRM</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { margin: 10px 0; padding: 10px; width: 100%; }
    #reader { width: 100vw; height: 100vh; display: none; }
  </style>
</head>
<body>
  <h2>üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</h2>
  <input type="text" id="searchInput" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞" />
  <button onclick="searchByInput()">–ü–æ–∏—Å–∫</button>
  <button onclick="toggleQR()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>

  <div id="reader"></div>
  <div id="result"></div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    Telegram.WebApp.ready();

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
      document.body.innerHTML = "<p>‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>";
      throw new Error("–¢–æ–∫–µ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω");
    }

    // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR
    async function toggleQR() {
      const reader = document.getElementById('reader');
      const isVisible = reader.style.display === 'block';
      
      if (!isVisible) {
        reader.style.display = 'block';
        const html5QrCode = new Html5Qrcode("reader");
        
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          async (decodedText) => {
            reader.style.display = 'none';
            document.getElementById('searchInput').value = decodedText;
            await search(decodedText);
          },
          (errorMessage) => console.warn("–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:", errorMessage)
        );
      } else {
        reader.style.display = 'none';
      }
    }

    // –ü–æ–∏—Å–∫ –ø–æ –≤–≤–æ–¥—É
    async function searchByInput() {
      const text = document.getElementById('searchInput').value.trim();
      if (!text) {
        alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
        return;
      }
      await search(text);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ loyaltyAPI
    async function search(query) {
      const url = `https://loyalty-api.p-h.app/api/v3/GuestInfo/${token}`;
      const body = query.includes('@') || query.length < 10 
        ? { Phone: query } 
        : { CardNumber: query };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();
        const resultDiv = document.getElementById('result');
        
        if (data.Status === 1) {
          resultDiv.innerHTML = `
            <h3>üë§ –ö–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω</h3>
            <p>–§–ò–û: ${data.Lastname} ${data.Firstname} ${data.MiddleName}</p>
            <p>–¢–µ–ª–µ—Ñ–æ–Ω: ${data.Phone}</p>
            <p>–ö–∞—Ä—Ç–∞: ${data.CardNumber}</p>
            <p>–ë–æ–Ω—É—Å—ã: ${data.BonusBalance}</p>
          `;
        } else {
          resultDiv.innerHTML = `<p>‚ö†Ô∏è ${data.ErrorMessage}</p>`;
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ API:", error);
        document.getElementById('result').innerHTML = "<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API.</p>";
      }
    }
  </script>
</body>
</html>
