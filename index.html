<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–∫–∞–Ω–µ—Ä –∫–∞—Ä—Ç—ã QR</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1em;
    }
    h2 {
      font-size: 1.5em;
      margin-bottom: 1em;
    }
    #reader {
      width: 90%;
      max-width: 500px;
      margin: auto;
      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    #reader__dashboard_section_csr span {
      font-size: 1.2em;
    }
    #reader__dashboard_section_csr select {
      font-size: 1.2em;
      padding: 5px;
    }
    #result {
      margin-top: 1.5em;
      font-size: 1.3em;
      font-weight: bold;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h2>üì∑ –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥</h2>
  <div id="reader"></div>
  <div id="result">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>

  <script>
    function onScanSuccess(decodedText, decodedResult) {
      console.log(`Code matched = ${decodedText}`, decodedResult);
      document.getElementById("result").innerText = "–ù–∞–π–¥–µ–Ω –∫–æ–¥: " + decodedText;
      html5QrcodeScanner.clear();

      const baseDeepLink = window.location.hash.substring(1);
      let finalDeepLink = null;

      if (baseDeepLink && baseDeepLink.includes("t.me") && baseDeepLink.includes("?start=QR_")) {
        finalDeepLink = baseDeepLink + decodedText;
        console.log(`Constructed finalDeepLink: ${finalDeepLink}`);
        document.getElementById("result").innerText = "–ì–æ—Ç–æ–≤–∏–º —Å—Å—ã–ª–∫—É –¥–ª—è Telegram...";
      } else {
        console.error("Base deep link not found or invalid in URL hash! Hash: ", window.location.hash);
        document.getElementById("result").innerText = "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –±–æ—Ç.";
        return;
      }

      try {
        document.getElementById("result").innerText = "–ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å Telegram...";
        const link = document.createElement('a');
        link.href = finalDeepLink;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log("Simulated click on link to:", finalDeepLink);
      } catch (e) {
        console.error("Error simulating link click:", e);
        document.getElementById("result").innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å Telegram. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.";
        showManualLink(finalDeepLink);
      }
    }

    function showManualLink(url) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "–ù–∞–π–¥–µ–Ω –∫–æ–¥: " + url.substring(url.lastIndexOf('_') + 1) + "<br>";
      const manualLink = document.createElement('a');
      manualLink.href = url;
      manualLink.innerText = "üîó –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram";
      manualLink.style.display = 'inline-block';
      manualLink.style.marginTop = '1em';
      manualLink.style.padding = '0.8em 1.5em';
      manualLink.style.backgroundColor = '#007bff';
      manualLink.style.color = 'white';
      manualLink.style.textDecoration = 'none';
      manualLink.style.borderRadius = '5px';
      resultDiv.appendChild(manualLink);
    }

    function onScanFailure(error) {
    }

    const html5QrcodeScanner = new Html5QrcodeScanner(
      "reader", 
      { 
        fps: 10, 
        qrbox: { width: 250, height: 250 },
        facingMode: "environment" 
      }, 
      false);
      
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
  </script>
</body>
</html>

